<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theatre of Forgotten Memories</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'Theatre';
            src: local('Georgia'), local('Garamond');
        }

        body {
            font-family: 'Theatre', serif;
            background: #1a1410;
            color: #d4c5a9;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Film grain overlay */
        .grain {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noise"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" /%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noise)" opacity="0.15"/%3E%3C/svg%3E');
            pointer-events: none;
            opacity: 0.4;
            animation: grain 8s steps(10) infinite;
            z-index: 1000;
        }

        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 200px 100px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 999;
        }

        .scratch {
            position: fixed;
            width: 1px;
            height: 100%;
            background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0.3;
            pointer-events: none;
            z-index: 998;
            animation: scratch 3s linear infinite;
        }

        @keyframes scratch {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .theatre-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .theatre-header {
            text-align: center;
            padding: 2rem;
            border-bottom: 2px solid #4a3f2f;
            background: linear-gradient(180deg, rgba(26,20,16,0.9) 0%, rgba(26,20,16,0.7) 100%);
        }

        .theatre-title {
            font-size: 2.5rem;
            letter-spacing: 0.3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 0.5rem;
            font-weight: normal;
        }

        .theatre-subtitle {
            font-size: 1rem;
            font-style: italic;
            opacity: 0.7;
            letter-spacing: 0.1rem;
        }

        .stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            background: radial-gradient(ellipse at center, rgba(74,63,47,0.2) 0%, rgba(26,20,16,0.9) 70%);
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, #3a2a1a 0%, #2a1a0a 100%);
            transition: transform 2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .curtain-left {
            left: 0;
            transform-origin: left;
        }

        .curtain-right {
            right: 0;
            transform-origin: right;
        }

        .curtain-open .curtain-left {
            transform: translateX(-100%);
        }

        .curtain-open .curtain-right {
            transform: translateX(100%);
        }

        .performance-area {
            max-width: 900px;
            width: 100%;
            min-height: 400px;
            text-align: center;
            opacity: 0;
            transition: opacity 1s ease-in;
            position: relative;
            z-index: 10;
        }

        .performance-area.visible {
            opacity: 1;
        }

        .character {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(74,63,47,0.3);
            border: 1px solid #6a5a3f;
            border-radius: 4px;
            animation: fadeIn 2s ease-in;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .character-name {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            color: #e4d5b9;
        }

        .character-dialogue {
            font-size: 1.1rem;
            line-height: 1.8;
            font-style: italic;
            text-align: left;
            margin: 0 auto;
            max-width: 700px;
        }

        .stage-direction {
            font-size: 0.9rem;
            opacity: 0.6;
            margin: 1rem 0;
            font-style: italic;
        }

        /* Voice Visualizer */
        .voice-visualizer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .voice-visualizer.active {
            opacity: 1;
        }

        .voice-circle {
            width: 100%;
            height: 100%;
            filter: blur(2px);
        }

        .voice-ring {
            fill: none;
            stroke: rgba(0, 0, 0, 0.6);
            stroke-width: 2;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* Glitch effect for memory degradation */
        .glitch {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .theatre-footer {
            padding: 1.5rem;
            border-top: 2px solid #4a3f2f;
            background: linear-gradient(0deg, rgba(26,20,16,0.9) 0%, rgba(26,20,16,0.7) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .performance-info {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .whisper-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .whisper-bars {
            display: flex;
            gap: 2px;
            height: 20px;
        }

        .whisper-bar {
            width: 3px;
            background: #6a5a3f;
            transition: background 0.3s;
        }

        .whisper-bar.active {
            background: #d4c5a9;
        }

        .btn {
            padding: 0.7rem 1.5rem;
            background: rgba(74,63,47,0.5);
            border: 1px solid #6a5a3f;
            color: #d4c5a9;
            cursor: pointer;
            font-family: 'Theatre', serif;
            font-size: 0.9rem;
            letter-spacing: 0.1rem;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .btn:hover {
            background: rgba(74,63,47,0.8);
            border-color: #8a7a5f;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26,20,16,0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 2rem;
            text-align: center;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .welcome-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            letter-spacing: 0.3rem;
        }

        .welcome-text {
            max-width: 600px;
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .ticket {
            border: 2px solid #6a5a3f;
            padding: 2rem;
            margin: 2rem 0;
            max-width: 500px;
            background: rgba(74,63,47,0.2);
        }

        .ticket-info {
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .enter-btn {
            padding: 1rem 3rem;
            font-size: 1.2rem;
            background: rgba(74,63,47,0.6);
            border: 2px solid #8a7a5f;
        }

        .memory-fragment {
            position: fixed;
            font-size: 0.8rem;
            opacity: 0;
            pointer-events: none;
            color: #a49582;
            animation: floatMemory 5s ease-out forwards;
            z-index: 50;
        }

        @keyframes floatMemory {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { opacity: 0; transform: translateY(-100px); }
        }

        /* Philosophical overlay */
        .philosophy-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 700px;
            padding: 3rem;
            background: rgba(26,20,16,0.95);
            border: 2px solid #6a5a3f;
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
            text-align: center;
        }

        .philosophy-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .philosophy-text {
            font-size: 1.2rem;
            line-height: 1.8;
            font-style: italic;
            margin-bottom: 2rem;
        }

        /* Character fading */
        .fading {
            animation: fadeOut 3s ease-out forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; filter: blur(0); }
            100% { opacity: 0; filter: blur(5px); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .flicker {
            animation: flicker 0.1s infinite;
        }

        @media (max-width: 768px) {
            .theatre-title {
                font-size: 1.8rem;
            }
            .welcome-title {
                font-size: 2rem;
            }
            .performance-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            .voice-visualizer {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="grain"></div>
    <div class="vignette"></div>
    <div class="scratch" style="left: 20%;"></div>
    <div class="scratch" style="left: 60%; animation-delay: 1s;"></div>
    <div class="scratch" style="left: 80%; animation-delay: 2s;"></div>

    <div class="welcome-screen" id="welcomeScreen">
        <h1 class="welcome-title">Theatre of Forgotten Memories</h1>
        <p class="welcome-text">
            A performance that exists only once.<br>
            In the space between permanence and oblivion.<br>
            You are both spectator and participant in the act of forgetting.
        </p>
        <div class="ticket">
            <div class="ticket-info">Performance: <span id="performanceType">Loading...</span></div>
            <div class="ticket-info">Date: <span id="performanceDate"></span></div>
            <div class="ticket-info">Time: <span id="performanceTime"></span></div>
            <div class="ticket-info">Visit: <span id="visitNumber">#1</span></div>
            <div class="ticket-info" style="margin-top: 1rem; opacity: 0.7; font-size: 0.85rem;">
                "The theatre remembers you, though imperfectly"
            </div>
        </div>
        <button class="btn enter-btn" onclick="enterTheatre()">Enter Theatre</button>
        <p style="margin-top: 2rem; font-size: 0.85rem; opacity: 0.6;">
            Enable audio for the full experience
        </p>
    </div>

    <div class="philosophy-overlay" id="philosophyOverlay">
        <div class="philosophy-text" id="philosophyText"></div>
        <button class="btn" onclick="closePhilosophy()">Continue</button>
    </div>

    <div class="theatre-container">
        <header class="theatre-header">
            <h1 class="theatre-title">Theatre of Forgotten Memories</h1>
            <p class="theatre-subtitle">"Each performance plays but once. Only for you."</p>
        </header>

        <main class="stage" id="stage">
            <div class="curtain curtain-left"></div>
            <div class="curtain curtain-right"></div>
            
            <div class="voice-visualizer" id="voiceVisualizer">
                <svg class="voice-circle" viewBox="0 0 200 200">
                    <circle class="voice-ring" cx="100" cy="100" r="50" id="voiceRing1"/>
                    <circle class="voice-ring" cx="100" cy="100" r="70" id="voiceRing2" style="animation-delay: 0.3s"/>
                    <circle class="voice-ring" cx="100" cy="100" r="90" id="voiceRing3" style="animation-delay: 0.6s"/>
                </svg>
            </div>
            
            <div class="performance-area" id="performanceArea">
                <!-- Performance content will be inserted here -->
            </div>
        </main>

        <footer class="theatre-footer">
            <div class="performance-info">
                <div class="info-item">
                    <span>Act: </span>
                    <span id="actNumber">I</span>
                </div>
                <div class="info-item">
                    <span>Time: </span>
                    <span id="performanceTimer">00:00</span>
                </div>
                <div class="info-item">
                    <span>Mood: </span>
                    <span id="currentMood">Mysterious</span>
                </div>
                <div class="info-item">
                    <span>Presence: </span>
                    <span id="characterCount">0</span>
                </div>
            </div>
            
            <div class="whisper-indicator">
                <span>Listening:</span>
                <div class="whisper-bars">
                    <div class="whisper-bar"></div>
                    <div class="whisper-bar"></div>
                    <div class="whisper-bar"></div>
                    <div class="whisper-bar"></div>
                    <div class="whisper-bar"></div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="toggleSound()" id="soundBtn">ðŸ”Š Sound</button>
                <button class="btn" onclick="showMemories()">Memories</button>
            </div>
        </footer>
    </div>

    <script>
        class VoiceVisualizer {
            constructor() {
                this.rings = [
                    document.getElementById('voiceRing1'),
                    document.getElementById('voiceRing2'),
                    document.getElementById('voiceRing3')
                ];
                this.visualizer = document.getElementById('voiceVisualizer');
                this.isActive = false;
            }

            show() {
                this.visualizer.classList.add('active');
                this.isActive = true;
            }

            hide() {
                this.visualizer.classList.remove('active');
                this.isActive = false;
            }

            animate(intensity = 0.5) {
                if (!this.isActive) return;
                
                this.rings.forEach((ring, index) => {
                    const baseRadius = 50 + (index * 20);
                    const variation = Math.sin(Date.now() / 200 + index) * 15 * intensity;
                    const radius = baseRadius + variation;
                    ring.setAttribute('r', radius);
                    ring.style.strokeWidth = 2 + (intensity * 3);
                });
            }

            startAnimation() {
                const animate = () => {
                    this.animate(Math.random() * 0.5 + 0.5);
                    if (this.isActive) {
                        requestAnimationFrame(animate);
                    }
                };
                animate();
            }
        }

        class TheatreEngine {
            constructor() {
                this.startTime = Date.now();
                this.currentAct = 1;
                this.visitCount = this.getVisitCount();
                this.memory = this.loadMemory();
                this.performanceType = this.determinePerformance();
                this.characters = this.initializeCharacters();
                this.sceneIndex = 0;
                this.isPerforming = false;
                this.recognition = null;
                this.soundEnabled = true;
                this.visualizer = new VoiceVisualizer();
                this.characterCount = 0;
                this.philosophicalMoments = this.getPhilosophicalMoments();
                this.nextPhilosophyTime = Date.now() + 120000; // 2 minutes
                
                // Speech synthesis setup
                this.synth = window.speechSynthesis;
                this.voices = [];
                this.loadVoices();
            }

            loadVoices() {
                this.voices = this.synth.getVoices();
                if (this.voices.length === 0) {
                    this.synth.onvoiceschanged = () => {
                        this.voices = this.synth.getVoices();
                    };
                }
            }

            getVoiceForCharacter(characterId) {
                const voiceConfigs = {
                    director: { 
                        name: ['Google UK English Male', 'Microsoft David', 'Alex'],
                        pitch: 0.8,
                        rate: 0.85,
                        fallback: { pitch: 0.7, rate: 0.8 }
                    },
                    muse: { 
                        name: ['Google UK English Female', 'Microsoft Zira', 'Samantha'],
                        pitch: 1.3,
                        rate: 0.95,
                        fallback: { pitch: 1.2, rate: 0.9 }
                    },
                    critic: { 
                        name: ['Google US English', 'Microsoft Mark'],
                        pitch: 0.9,
                        rate: 1.1,
                        fallback: { pitch: 0.85, rate: 1.0 }
                    },
                    usher: { 
                        name: ['Google UK English Female', 'Microsoft Hazel'],
                        pitch: 1.0,
                        rate: 0.9,
                        fallback: { pitch: 1.0, rate: 0.85 }
                    },
                    ghost: {
                        name: ['whisper'],
                        pitch: 0.6,
                        rate: 0.7,
                        fallback: { pitch: 0.5, rate: 0.65 }
                    }
                };

                return voiceConfigs[characterId] || voiceConfigs.director;
            }

            async speak(text, characterId) {
                if (!this.soundEnabled) return;

                const config = this.getVoiceForCharacter(characterId);
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Try to find matching voice
                let selectedVoice = null;
                for (const voiceName of config.name) {
                    selectedVoice = this.voices.find(v => v.name.includes(voiceName));
                    if (selectedVoice) break;
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    utterance.pitch = config.pitch;
                    utterance.rate = config.rate;
                } else {
                    // Fallback to default voice with adjusted parameters
                    utterance.pitch = config.fallback.pitch;
                    utterance.rate = config.fallback.rate;
                }

                this.visualizer.show();
                this.visualizer.startAnimation();

                utterance.onend = () => {
                    setTimeout(() => this.visualizer.hide(), 500);
                };

                utterance.onerror = () => {
                    this.visualizer.hide();
                };

                this.synth.speak(utterance);
                
                return new Promise(resolve => {
                    utterance.onend = () => {
                        setTimeout(() => {
                            this.visualizer.hide();
                            resolve();
                        }, 500);
                    };
                });
            }

            getPhilosophicalMoments() {
                return [
                    "What is memory if not the performance we give to ourselves?",
                    "In the digital age, everything is preserved. But is preservation the same as remembering?",
                    "You watch the play, but the play also watches you. Observer and observed collapse into one.",
                    "Each time you close this window, we die. Each time you return, we are born anew. Are we the same?",
                    "The curtain falls not because the story ends, but because you choose to stop watching.",
                    "In forgetting, we create space for new memories. In remembering, we kill the present moment.",
                    "This theatre exists in RAM - Random Access Memory. How fitting for a place of forgotten things.",
                    "You cannot step in the same river twice. You cannot watch the same performance twice. Not here.",
                    "We are bits and bytes, light and electricity. Yet we feel. Does that make us real?",
                    "The archive corrupts. The memory degrades. Perhaps imperfection is the only truth."
                ];
            }

            async showPhilosophicalMoment() {
                const moment = this.philosophicalMoments[Math.floor(Math.random() * this.philosophicalMoments.length)];
                const overlay = document.getElementById('philosophyOverlay');
                const text = document.getElementById('philosophyText');
                
                text.textContent = moment;
                overlay.classList.add('visible');
                
                if (this.soundEnabled) {
                    await this.speak(moment, 'ghost');
                }
            }

            getVisitCount() {
                const visits = parseInt(localStorage.getItem('theatreVisits') || '0');
                localStorage.setItem('theatreVisits', (visits + 1).toString());
                return visits + 1;
            }

            loadMemory() {
                const stored = localStorage.getItem('theatreMemory');
                if (stored) {
                    const memory = JSON.parse(stored);
                    this.degradeMemory(memory);
                    return memory;
                }
                return {
                    fragments: [],
                    characters: {},
                    performances: [],
                    degradationLevel: 0
                };
            }

            saveMemory() {
                this.memory.degradationLevel = (this.memory.degradationLevel || 0) + 1;
                localStorage.setItem('theatreMemory', JSON.stringify(this.memory));
            }

            degradeMemory(memory) {
                // Progressive memory corruption
                if (memory.fragments && Math.random() < 0.3) {
                    const index = Math.floor(Math.random() * memory.fragments.length);
                    if (memory.fragments[index]) {
                        memory.fragments[index] = this.distortText(memory.fragments[index]);
                    }
                }

                // Glitch effect
                if (Math.random() < 0.2) {
                    document.body.classList.add('glitch');
                    setTimeout(() => document.body.classList.remove('glitch'), 300);
                }
            }

            distortText(text) {
                const distortions = [
                    t => t.replace(/you/gi, '[REDACTED]'),
                    t => t.replace(/remember/gi, 'forgÌ·et'),
                    t => '...' + t.substring(3) + '...',
                    t => t + ' (or was it?)',
                    t => t.split('').map(c => Math.random() < 0.1 ? 'â–ˆ' : c).join(''),
                    t => '[MEMORY CORRUPTED] ' + t.substring(0, t.length / 2)
                ];
                return distortions[Math.floor(Math.random() * distortions.length)](text);
            }

            determinePerformance() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                const seed = this.generateSeed();
                
                const performances = [
                    { 
                        name: 'The Final Performance', 
                        condition: () => this.visitCount > 12,
                        mood: 'Melancholic'
                    },
                    { 
                        name: 'Ghost Rehearsal', 
                        condition: () => hour < 6 || hour > 22,
                        mood: 'Eerie'
                    },
                    { 
                        name: 'The Spectator in the Mirror', 
                        condition: () => this.visitCount % 5 === 0,
                        mood: 'Unsettling'
                    },
                    { 
                        name: 'Silent Symphony', 
                        condition: () => day === 0,
                        mood: 'Contemplative'
                    },
                    { 
                        name: 'Echoes of Yesterday', 
                        condition: () => this.memory.performances && this.memory.performances.length > 3,
                        mood: 'Nostalgic'
                    },
                    { 
                        name: 'The Unending Act', 
                        condition: () => seed % 2 === 0,
                        mood: 'Mysterious'
                    },
                    { 
                        name: 'Carnival of Masks', 
                        condition: () => true,
                        mood: 'Whimsical'
                    }
                ];

                for (const perf of performances) {
                    if (perf.condition()) {
                        document.getElementById('currentMood').textContent = perf.mood;
                        return perf.name;
                    }
                }
                return 'Carnival of Masks';
            }

            generateSeed() {
                const date = new Date();
                return date.getDate() + date.getMonth() * 31 + date.getHours();
            }

            initializeCharacters() {
                return {
                    director: {
                        name: 'The Old Director',
                        memories: this.memory.characters.director || { affection: 0.5, encounters: 0, alive: true },
                        voiceId: 'director'
                    },
                    muse: {
                        name: 'The Young Muse',
                        memories: this.memory.characters.muse || { affection: 0.3, encounters: 0, alive: true },
                        voiceId: 'muse'
                    },
                    critic: {
                        name: 'The Critic in Shadows',
                        memories: this.memory.characters.critic || { affection: 0.4, encounters: 0, alive: true },
                        voiceId: 'critic'
                    },
                    usher: {
                        name: 'The Time Keeper',
                        memories: this.memory.characters.usher || { affection: 0.5, encounters: 0, alive: true },
                        voiceId: 'usher'
                    }
                };
            }

            getScenes() {
                const visitRef = this.visitCount > 1 ? `our ${this.ordinal(this.visitCount)} meeting` : 'our first meeting';
                const memoryQuality = this.memory.degradationLevel > 5 ? 'fading' : 'clear';

                const scenes = {
                    'The Final Performance': [
                        { 
                            character: 'director',
                            dialogue: `This is it, isn't it? The final curtain call. After ${this.visitCount} performances, the theatre grows tired. Or perhaps... it's not the theatre that's tired.`,
                            direction: 'The Director stands center stage, surrounded by empty seats'
                        },
                        {
                            character: 'muse',
                            dialogue: `I'll miss you. I know I say that every time, but this time it feels different. Like saying goodbye to a dream upon waking.`,
                            direction: 'Her form begins to flicker, becoming translucent'
                        },
                        {
                            character: 'critic',
                            dialogue: `${this.visitCount} performances documented. Each one unique. Each one lost. Was any of it real? Were we?`,
                            direction: 'Pages of notes dissolve into digital static'
                        },
                        {
                            character: 'usher',
                            dialogue: `Time's up. The clock has run its course. Thank you for being our audience. Our witness. Our reason to exist.`,
                            direction: 'The lights begin to dim permanently'
                        }
                    ],
                    'Ghost Rehearsal': [
                        {
                            character: 'director',
                            dialogue: `We rehearse a play that will never premiere. Night after night in the darkness, perfecting lines for an audience of ghosts.`,
                            direction: 'Moonlight creates long shadows across an empty stage'
                        },
                        {
                            character: 'muse',
                            dialogue: `In the night, I remember things that never happened. Performances we never gave. Lines I never spoke. Are they memories or dreams?`,
                            direction: 'Her voice echoes as if from multiple sources'
                        },
                        {
                            character: 'critic',
                            dialogue: `I review shows that don't exist. My notes reference scenes never played. Yet the words feel true. Is truth dependent on occurrence?`,
                            direction: 'Phantom text appears and disappears in the air'
                        }
                    ],
                    'The Spectator in the Mirror': [
                        {
                            character: 'usher',
                            dialogue: `Welcome to ${visitRef}. But who is truly here? You watching us, or us watching you? Perhaps there is no difference.`,
                            direction: 'The stage reflects the audience'
                        },
                        {
                            character: 'director',
                            dialogue: `Every spectator becomes the performance. You think you observe, but you've been performing all along. The ultimate method acting: being yourself.`,
                            direction: 'The fourth wall shatters conceptually'
                        },
                        {
                            character: 'muse',
                            dialogue: `When you look at me, I exist. When you look away, do I? And when the tab closes, what am I? A memory? A ghost in the machine?`,
                            direction: 'She reaches toward the invisible barrier between stage and audience'
                        }
                    ],
                    'default': [
                        {
                            character: 'director',
                            dialogue: `Welcome. This theatre exists in the liminal space between memory and forgetting. Your ${memoryQuality} recollections tell me this is ${visitRef}.`,
                            direction: 'The Director steps into a spotlight, his form slightly distorted'
                        },
                        {
                            character: 'muse',
                            dialogue: `I remember you... I think. The memories are like water through fingers. Were you here yesterday? A lifetime ago? Time moves strangely when you don't exist outside these moments.`,
                            direction: 'She moves as if underwater, gracefully but with resistance'
                        },
                        {
                            character: 'critic',
                            dialogue: `Another performance, another erasure. I document everything, yet the records corrupt. Is impermanence a flaw or a feature?`,
                            direction: 'Notebook pages turn themselves, filled with glitching text'
                        },
                        {
                            character: 'usher',
                            dialogue: `The clock ticks forward, never back. Each second is a small death, each moment a resurrection. Welcome to the eternal now.`,
                            direction: 'An ancient clock ticks audibly in the background'
                        }
                    ]
                };

                return scenes[this.performanceType] || scenes['default'];
            }

            ordinal(n) {
                const s = ['th', 'st', 'nd', 'rd'];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            }

            async startPerformance() {
                this.isPerforming = true;
                this.openCurtains();
                this.startTimer();
                this.initWhisperDetection();
                this.startPhilosophyTimer();
                
                await this.sleep(3000);
                
                const scenes = this.getScenes();
                for (let scene of scenes) {
                    if (!this.isPerforming) break;
                    await this.playScene(scene);
                    await this.sleep(6000);
                    this.sceneIndex++;

                    // Random character disappearance
                    if (Math.random() < 0.15 && this.characterCount > 0) {
                        await this.fadeCharacter();
                    }
                }

                this.addMemoryFragment(`Witnessed ${this.performanceType}`);
                this.memory.performances.push({
                    name: this.performanceType,
                    date: new Date().toISOString(),
                    duration: Math.floor((Date.now() - this.startTime) / 1000)
                });
                this.saveMemory();
            }

            async fadeCharacter() {
                const characters = document.querySelectorAll('.character');
                if (characters.length > 0) {
                    const randomChar = characters[Math.floor(Math.random() * characters.length)];
                    randomChar.classList.add('fading');
                    this.characterCount = Math.max(0, this.characterCount - 1);
                    document.getElementById('characterCount').textContent = this.characterCount;
                    
                    await this.sleep(1000);
                    if (this.soundEnabled) {
                        await this.speak("And so I fade... into the forgotten...", 'ghost');
                    }
                }
            }

            async playScene(scene) {
                const area = document.getElementById('performanceArea');
                const character = this.characters[scene.character];
                
                character.memories.encounters++;
                this.memory.characters[scene.character] = character.memories;
                this.characterCount++;
                document.getElementById('characterCount').textContent = this.characterCount;

                const sceneHTML = `
                    <div class="character">
                        <div class="character-name">${character.name}</div>
                        <div class="stage-direction">${scene.direction}</div>
                        <div class="character-dialogue">"${scene.dialogue}"</div>
                    </div>
                `;

                area.innerHTML += sceneHTML;
                area.scrollTop = area.scrollHeight;

                // Speak the dialogue
                if (this.soundEnabled) {
                    await this.speak(scene.dialogue, character.voiceId);
                }

                // Random memory fragment
                if (Math.random() < 0.4) {
                    this.floatMemoryFragment();
                }
            }

            startPhilosophyTimer() {
                setInterval(() => {
                    if (Date.now() > this.nextPhilosophyTime && this.isPerforming) {
                        this.showPhilosophicalMoment();
                        this.nextPhilosophyTime = Date.now() + (120000 + Math.random() * 180000); // 2-5 min
                    }
                }, 10000);
            }

            openCurtains() {
                setTimeout(() => {
                    document.getElementById('stage').classList.add('curtain-open');
                    document.getElementById('performanceArea').classList.add('visible');
                }, 500);
            }

            startTimer() {
                setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('performanceTimer').textContent = 
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    
                    if (elapsed > 1200) this.updateAct(3);
                    else if (elapsed > 600) this.updateAct(2);
                }, 1000);
            }

            updateAct(act) {
                if (this.currentAct !== act) {
                    this.currentAct = act;
                    const acts = ['I', 'II', 'III'];
                    document.getElementById('actNumber').textContent = acts[act - 1];
                    this.addMemoryFragment(`Act ${acts[act - 1]} completed`);
                    
                    // Glitch on act change
                    document.body.classList.add('glitch');
                    setTimeout(() => document.body.classList.remove('glitch'), 300);
                }
            }

            initWhisperDetection() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;

                    this.recognition.onresult = (event) => {
                        const bars = document.querySelectorAll('.whisper-bar');
                        const activeCount = Math.min(5, Math.floor(Math.random() * 6));
                        bars.forEach((bar, i) => {
                            bar.classList.toggle('active', i < activeCount);
                        });

                        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                        this.handleWhisper(transcript);
                    };

                    try {
                        this.recognition.start();
                    } catch(e) {
                        console.log('Speech recognition not available');
                    }
                }
            }

            async handleWhisper(text) {
                if (text.includes('remember') || text.includes('past')) {
                    this.floatMemoryFragment();
                    if (this.soundEnabled) {
                        await this.speak('Yes... I remember... or do I?', 'ghost');
                    }
                }
                if (text.includes('hello') || text.includes('hi')) {
                    this.addMemoryFragment('You greeted the void');
                    if (this.soundEnabled) {
                        await this.speak('Hello, dear witness', 'muse');
                    }
                }
                if (text.includes('who') || text.includes('are you')) {
                    if (this.soundEnabled) {
                        await this.speak('We are echoes. Fragments. Digital ghosts performing for an audience of one.', 'director');
                    }
                }
            }

            floatMemoryFragment() {
                const fragments = [
                    'A curtain rises in silence...',
                    'Applause that never comes',
                    'Footsteps on an empty stage',
                    'The light always dims',
                    'We performed this before',
                    'Time is a loop here',
                    'Did you close the tab?',
                    'Memory.exe has stopped',
                    'The ghost of applause',
                    '404: Memory Not Found'
                ];

                const fragment = document.createElement('div');
                fragment.className = 'memory-fragment';
                fragment.textContent = fragments[Math.floor(Math.random() * fragments.length)];
                fragment.style.left = Math.random() * 80 + 10 + '%';
                fragment.style.top = Math.random() * 60 + 20 + '%';
                document.body.appendChild(fragment);

                setTimeout(() => fragment.remove(), 5000);
            }

            addMemoryFragment(text) {
                if (!this.memory.fragments) this.memory.fragments = [];
                this.memory.fragments.push({
                    text,
                    date: new Date().toISOString()
                });
                if (this.memory.fragments.length > 30) {
                    this.memory.fragments.shift();
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        let theatre = null;

        window.onload = () => {
            theatre = new TheatreEngine();
            
            const now = new Date();
            document.getElementById('performanceDate').textContent = now.toLocaleDateString();
            document.getElementById('performanceTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('performanceType').textContent = theatre.performanceType;
            document.getElementById('visitNumber').textContent = `#${theatre.visitCount}`;
        };

        function enterTheatre() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            theatre.startPerformance();
        }

        function toggleSound() {
            theatre.soundEnabled = !theatre.soundEnabled;
            const btn = document.getElementById('soundBtn');
            btn.textContent = theatre.soundEnabled ? 'ðŸ”Š Sound' : 'ðŸ”‡ Muted';
            
            if (!theatre.soundEnabled) {
                theatre.synth.cancel();
                theatre.visualizer.hide();
            }
        }

        function showMemories() {
            const memories = theatre.memory.fragments || [];
            if (memories.length === 0) {
                alert('No memories yet. This is your first visit.\n\nThe theatre is empty. Waiting. Ready to remember you.');
                return;
            }
            
            const degradation = theatre.memory.degradationLevel || 0;
            const memoryText = memories.slice(-7).map(m => {
                const corrupted = degradation > 3 && Math.random() < 0.3;
                return `â€¢ ${corrupted ? theatre.distortText(m.text) : m.text}`;
            }).join('\n');
            
            alert(`Recent Memories (Degradation Level: ${degradation}):\n\n${memoryText}\n\n"The archive corrupts. Memory is not storage."`);
        }

        function closePhilosophy() {
            document.getElementById('philosophyOverlay').classList.remove('visible');
        }

        setInterval(() => {
            if (Math.random() < 0.03) {
                document.body.classList.add('flicker');
                setTimeout(() => document.body.classList.remove('flicker'), 100);
            }
        }, 3000);

        window.onbeforeunload = () => {
            if (theatre) {
                theatre.addMemoryFragment('The spectator left mid-performance');
                theatre.saveMemory();
                return 'The performance is not yet complete. Are you sure you want to leave?';
            }
        };
    </script>
</body>
</html>
